---
date: 2024-06-02
category: release
authors:
  - name: Pooya Parsa
    github: pi0
---

# H3 v2-beta - Try it now!

> H3 v2-beta is finally ready to try, featuring a complete rewrite based on Web standards, backward compatibility, and a significant performance boost!

H3 was born around five years ago in late 2020, during the rise of edge Workers. Early H3 versions, using [unjs/unenv](https://github.com/unjs/unenv) and [Nitro](https://nitro.build), allowed H3 apps to run directly in worker runtimes. Since [v1.8](/blog/v1.8), H3 has enhanced its Web standards compatibility.

H3 v1 was primarily based on Node.js APIs with a compatibility layer for Web standards. Logical choice at the time, given Node.js's popularity amongst JavaScript server runtimes.

Thanks to evolving Web standards and improved runtime support (such as [Deno](https://deno.com/), [Bun](https://bun.sh/), and the latest [Node.js](https://nodejs.org/en)), the ecosystem is now ready to fully embrace Web standards for server development. Benefits include:

- ‚úÖ Cross-runtime interoperability (Node.js, Deno, Bun, Workers, etc.)
- ‚úÖ Cross-framework compatibility (Hono, Elysia, etc.)
- ‚úÖ Cross-environment compatibility (shared frontend and backend code)
- ‚úÖ Easier server API testing

## Srvx: Universal Server API

A big challenge is Node.js lacks native support for Web-standard HTTP servers. We need adapters to bridge `node.http.IncomingMessage` and `Request`, and handling `Response` via `node.http.ServerResponse`. Existing adapters didn't fully meet H3's requirements for modularity, performance, and compatibility.

Furthermore, each runtime that pioneered adopting Web standards for servers did not agree on specific implementation details. Typically, all new server runtimes accept a [`fetch`](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)-like handler, using [Request](https://developer.mozilla.org/en-US/docs/Web/API/Request) as input and returning a [Response](https://developer.mozilla.org/en-US/docs/Web/API/Response). However, since Web standards were not initially designed for server contexts, they lack standardized ways to access request context, IP information, handle WebSocket upgrades, or set server options. Consequently, each runtime created its own extensions. Today, initiatives like [WinterTC](https://wintertc.org/faq) aim to establish cross-runtime interoperability over time.

We created [üí• srvx](https://srvx.h3.dev) out of H3 development branch: An open, robust abstraction layer aiming to unify JavaScript server APIs:

```js
// Compatible with Deno, Bun, Node.js, Service Workers, and Edge
import { serve } from "srvx";

serve({
  port: 3000,
  fetch(request) {
    // request.ip
    // request.runtime?.{bun,deno,node,cloudflare,...}
    return new Response("üëã Hello there!");
  },
});
```

> [!NOTE]
> Srvx encapsulates runtime-specific addons under `request.runtime?`, avoiding extra context objects to be passed around.

With srvx handling runtime-specific API mappings, H3 can remain simpler, focusing exclusively on Web APIs while ensuring cross-runtime performance and compatibility from srvx.

## H3: Tiny Server Composer üé∂

Adopting Web APIs and leveraging [üí• srvx](https://srvx.h3.dev) simplified H3‚Äôs scope significantly.

- ‚úÖ A Web-standard server optimized for performance.
- ‚úÖ Simple responses and error handling (return or throw directly).
- ‚úÖ Fast routing via the tiny router ([üå≥ rou3](https://github.com/h3js/rou3)).
- ‚úÖ Middleware for request, response, and error interception.
- ‚úÖ Tiny core and composable utilities.

```js
import { H3, serve } from "h3";

const app = new H3().get("/", () => "‚ö°Ô∏è Tadaa!");

serve(app, { port: 3000 });
```

## Web-Compatible Event Context

H3 v2 fully embraces Web Platform APIs, minimizing additional conventions in context API.

```js
app.any("/**", async (event) => {
  const { pathname } = event.url; // Fast URL parsing
  const accept = event.req.headers.get("Accept");

  const bodyStream = await event.req.body;
  const bodyText = await event.req.text();
  const bodyJSON = await event.req.json();
  const bodyFormData = await event.req.formData();

  const { deno, bun, node } = event.req.runtime;

  event.res.headers.set("Content-Type", "application/json");

  return Response.json({ hello: "web" });
});
```

## Chainable Middleware

H3 now offers an ergonomic, composable way to chain middleware inspired by [Hono middleware](https://hono.dev/docs/guides/middleware) üíõ:

```js
app.use("/", async (event, next) => {
  console.log(`[${event.req.method}] ${event.req.url}`);
  const rawResponse = await next();
  event.res.headers.append("x-middleware", "works");
  return rawResponse;
});
```

> [!NOTE]
> Using `next()` is optional. Middleware can be written like v1 without returning a response.

## Bare-Metal Performance

One classic way to evaluate web frameworks is by comparing RPS (Requests Per Second). However, this metric can be misleading, as it is influenced by external factors such as the OS networking layer and runtime-specific behavior. It also overlooks other important aspects like bundle size and initialization time.

We approached benchmarking with a new system that focuses on measuring the overhead introduced by the framework itself. Our goal is to optimize all relevant measurements together, making it as close as possible to a baseline where H3 is not added or used.

- Response latency (`app.fetch(request)`)
- App initialization speed
- Bundle size

This method, allowed H3 v2 to be optimized on ¬µs-level latency improvements per request and dramatically smaller core bundle size.

> [!NOTE]
> Framework choice barely impacts application performance compared to network latency. These benchmarks primarily guide internal optimizations.

<!-- [TODO: Benchmark results vs v1] -->

## Migration from Version 1

We've minimized breaking changes.

::read-more{to="/migration"}
Check out new v2 [Migration Guide](/migration).
::

## Unified H(ttp) Server Tools

H3 and related projects moved to a dedicated [Github org](https://github.com/h3js) and [h3.dev](https://h3.dev) domain.

Under the H3 umbrella, we maintain several key components for universal JavaScript servers. All fully open and usable with or without H3, and with any JavaScript runtime.

- [‚ö°Ô∏è h3](https://github.com/h3js/h3): Minimal HTTP framework.
- [üå≥ rou3](https://github.com/h3js/rou3): Lightweight JavaScript router.
- [üí• srvx](https://srvx.h3.dev): Universal Web-based Server API.
- [üîå crossws](https://crossws.h3.dev): Cross-platform WebSocket server.

## Roadmap to v2 Stable

Next steps:

- Improve documentation and update examples.
- Gather feedback and more testing.
- Refine APIs based on community feedback.
- Ensure ecosystem compatibility and adopt with [Nitro](https://nitro.build) v3.

::callout{to="https://discord.h3.dev"}
Join our [Discord](https://discord.h3.dev) to share your experience and feedback!
::
